<h1>Admin Dashboard</h1>
<p id="welcome"></p>
<button onclick="logout()">Logout</button>

<h2>All Users</h2>
<table id="user-table" border="1">
  <tr><th>Username</th><th>Role</th><th>Actions</th></tr>
</table>

<h3>Change Role</h3>
<input id="target-username" placeholder="Username" />
<select id="new-role">
  <option value="admin">Admin</option>
  <option value="pharmacist">Pharmacist</option>
  <option value="customer">Customer</option>
</select>
<button onclick="changeRole()">Change Role</button>
<p id="role-result"></p>

<script>
  const token = localStorage.getItem('token');
  if (!token) window.location.href = "/static/auth.html";

  let payload = {};
  try {
    payload = JSON.parse(atob(token.split('.')[1]));
  } catch (err) {
    localStorage.removeItem('token');
    window.location.href = "/static/auth.html";
  }

  if (payload.role !== "admin") {
    alert("Access denied: Admins only.");
    window.location.href = "/static/auth.html";
  }

  document.getElementById("welcome").innerText = `Welcome, Admin ${payload.sub}`;

  function logout() {
    localStorage.removeItem('token');
    window.location.href = "/static/auth.html";
  }

  async function loadUsers() {
    const res = await fetch('/auth/users', {
      headers: { Authorization: `Bearer ${token}` }
    });
    const users = await res.json();
    const table = document.getElementById("user-table");

    users.forEach(user => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${user.username}</td>
        <td>${user.role}</td>
        <td><button onclick="deleteUser('${user.username}')">Delete</button></td>
      `;
      table.appendChild(row);
    });
  }

  async function deleteUser(username) {
    const res = await fetch(`/auth/delete-user/${username}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    alert(data.msg);
    location.reload();  // reload users
  }

  async function changeRole() {
    const username = document.getElementById('target-username').value;
    const new_role = document.getElementById('new-role').value;

    const res = await fetch('/auth/change-role', {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ username, new_role })
    });

    const data = await res.json();
    document.getElementById('role-result').innerText = data.msg || data.detail;
    if (res.ok) location.reload();
  }

  loadUsers();
</script>
